/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var E=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var B=Object.prototype.hasOwnProperty;var K=(c,t)=>{for(var e in t)E(c,e,{get:t[e],enumerable:!0})},U=(c,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of V(t))!B.call(c,i)&&i!==e&&E(c,i,{get:()=>t[i],enumerable:!(s=M(t,i))||s.enumerable});return c};var _=c=>U(E({},"__esModule",{value:!0}),c);var W={};K(W,{default:()=>A});module.exports=_(W);var $=require("obsidian");var v=class{constructor(t,e){this.embeddingProvider=t;this.vectorStore=e}async embedNote(t){let{noteId:e,notePath:s,content:i}=t;if(this.vectorStore.get(e))return;let n=await this.embeddingProvider.embed(i),r={noteId:e,notePath:s,vector:n,content:i.substring(0,500)};this.vectorStore.store(r)}async embedNotes(t,e){let s=t.filter(r=>!this.vectorStore.get(r.noteId));if(s.length===0)return;let i=10,n=0;for(let r=0;r<s.length;r+=i){let o=s.slice(r,r+i),a=o.map(g=>g.content),l=await this.embeddingProvider.embedBatch(a);for(let g=0;g<o.length;g++){let d=o[g],S={noteId:d.noteId,notePath:d.notePath,vector:l[g],content:d.content.substring(0,500)};this.vectorStore.store(S)}n+=o.length,e==null||e(n,s.length)}}async findSimilarByText(t,e){let s=await this.embeddingProvider.embed(t);return this.vectorStore.search(s,e)}findSimilarByNoteId(t,e){let s=this.vectorStore.get(t);if(!s)return[];let i={...e,excludeNoteIds:[...(e==null?void 0:e.excludeNoteIds)||[],t]};return this.vectorStore.search(s.vector,i)}hasEmbedding(t){return!!this.vectorStore.get(t)}getStats(){return{totalNotes:this.vectorStore.size()}}isAvailable(){return this.embeddingProvider.isAvailable()}clear(){this.vectorStore.clear()}};function p(c,t,e,s=0,i){return{id:`cluster_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:c,members:t,centroidVector:i,coherenceScore:s,source:e,createdAt:new Date}}var w=class{constructor(t,e){this.embeddingService=t;this.noteRepository=e}async clusterByTag(t){let e=await this.noteRepository.getNotesByTag(t);if(e.length===0)return p(`#${t}`,[],"tag",0);await this.embedNotes(e);let s=this.createMembers(e),i=await this.calculateCoherence(e);return p(`#${t}`,s,"tag",i)}async clusterByFolder(t){let e=await this.noteRepository.getNotesByFolder(t);if(e.length===0)return p(t,[],"folder",0);await this.embedNotes(e);let s=this.createMembers(e),i=await this.calculateCoherence(e);return p(t,s,"folder",i)}async autoCluster(t,e=.5,s=20){let i=await this.noteRepository.getNote(t);if(!i)return p("Unknown",[],"similarity",0);await this.embeddingService.embedNote({noteId:i.noteId,notePath:i.notePath,content:`${i.title}

${i.content}`});let n=this.embeddingService.findSimilarByNoteId(t,{threshold:e,limit:s-1}),r=[i];for(let l of n){let g=await this.noteRepository.getNoteByPath(l.notePath);g&&r.push(g)}let o=[{noteId:i.noteId,notePath:i.notePath,title:i.title,similarity:1},...n.map(l=>({noteId:l.noteId,notePath:l.notePath,title:l.noteId,similarity:l.similarity}))],a=o.length>1?o.slice(1).reduce((l,g)=>l+g.similarity,0)/(o.length-1):1;return p(`Similar to: ${i.title}`,o,"similarity",a)}async createManualCluster(t,e){let s=[];for(let r of t){let o=await this.noteRepository.getNote(r);o&&s.push(o)}if(s.length===0)return p(e,[],"manual",0);await this.embedNotes(s);let i=this.createMembers(s),n=await this.calculateCoherence(s);return p(e,i,"manual",n)}async embedNotes(t){let e=t.map(s=>({noteId:s.noteId,notePath:s.notePath,content:`${s.title}

${s.content}`}));await this.embeddingService.embedNotes(e)}createMembers(t){return t.map(e=>({noteId:e.noteId,notePath:e.notePath,title:e.title,similarity:1}))}async calculateCoherence(t){if(t.length<2)return 1;let e=0,s=0;for(let i=0;i<t.length;i++){let n=this.embeddingService.findSimilarByNoteId(t[i].noteId,{limit:t.length-1});for(let r of n)t.some(o=>o.noteId===r.noteId)&&(e+=r.similarity,s++)}return s>0?e/s:0}};var j={includeBacklinks:!0,autoSuggestTags:!0,language:"ko"};function k(c,t="framework",e={}){return{id:q(),sourceNoteIds:c,synthesisType:t,options:{...j,...e},createdAt:new Date}}function q(){return`syn_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}var b=class{constructor(t,e){this.synthesisGenerator=t;this.noteRepository=e}async execute(t){let{cluster:e,synthesisType:s,targetTitle:i,options:n}=t,r=e.members.map(g=>g.noteId);if(r.length===0)throw new Error("No notes to synthesize");let o=k(r,s,n);i?o.targetTitle=i:o.targetTitle=this.generateDefaultTitle(e,s);let a=await this.fetchNoteContents(r);if(a.length===0)throw new Error("Could not fetch any note contents");return{result:await this.synthesisGenerator.generate(o,a),request:o}}async saveResult(t,e){let s=this.sanitizeFileName(t.title),i=`${e}/${s}.md`,r=`${this.generateFrontmatter(t)}
${t.content}`;return await this.noteRepository.createNote(i,r),i}async fetchNoteContents(t){let e=[];for(let s of t){let i=await this.noteRepository.getNote(s);i&&e.push(i)}return e}generateDefaultTitle(t,e){let s={framework:"\uC885\uD569 \uD504\uB808\uC784\uC6CC\uD06C",summary:"\uC694\uC57D",comparison:"\uBE44\uAD50 \uBD84\uC11D",timeline:"\uD0C0\uC784\uB77C\uC778"};return`${t.name} - ${s[e]}`}sanitizeFileName(t){return t.replace(/[\\/:*?"<>|]/g,"").replace(/\s+/g," ").trim().substring(0,100)}generateFrontmatter(t){let e=["---",`title: "${t.title}"`,"type: synthesis",`synthesis_type: ${t.synthesisType}`,`created: ${t.createdAt.toISOString()}`,"sources:",...t.sourceNoteLinks.map(s=>`  - "${s}"`)];return t.suggestedTags.length>0&&(e.push("tags:"),e.push(...t.suggestedTags.map(s=>`  - "${s}"`))),e.push("---",""),e.join(`
`)}};var C=class{constructor(t,e){this.clusterNotesUseCase=t;this.noteRepository=e}async suggestByTags(t){let{minClusterSize:e=3,maxSuggestions:s=5,minCoherence:i=.4}=t||{},n=await this.noteRepository.getAllTags(),r=[];for(let o of n){let a=await this.clusterNotesUseCase.clusterByTag(o);a.members.length>=e&&a.coherenceScore>=i&&r.push({cluster:a,reason:`${a.members.length}\uAC1C\uC758 \uB178\uD2B8\uAC00 #${o} \uD0DC\uADF8\uB85C \uC5F0\uACB0\uB428 (\uC751\uC9D1\uB3C4: ${(a.coherenceScore*100).toFixed(0)}%)`,priority:this.calculatePriority(a),suggestedType:this.suggestSynthesisType(a)})}return this.sortAndLimit(r,s)}async suggestByFolders(t){let{minClusterSize:e=3,maxSuggestions:s=5,minCoherence:i=.3}=t||{},n=await this.noteRepository.getAllFolders(),r=[];for(let o of n){let a=await this.clusterNotesUseCase.clusterByFolder(o);a.members.length>=e&&a.coherenceScore>=i&&r.push({cluster:a,reason:`${a.members.length}\uAC1C\uC758 \uB178\uD2B8\uAC00 ${o} \uD3F4\uB354\uC5D0 \uC704\uCE58 (\uC751\uC9D1\uB3C4: ${(a.coherenceScore*100).toFixed(0)}%)`,priority:this.calculatePriority(a),suggestedType:this.suggestSynthesisType(a)})}return this.sortAndLimit(r,s)}async suggestBySimilarity(t,e){let{minClusterSize:s=3,maxSuggestions:i=5,minCoherence:n=.5}=e||{},r=[];for(let o of t){let a=await this.clusterNotesUseCase.autoCluster(o,.5,15);if(a.members.length>=s&&a.coherenceScore>=n){let l=a.members.find(g=>g.noteId===o);r.push({cluster:a,reason:`"${(l==null?void 0:l.title)||o}"\uC640 \uC758\uBBF8\uC801\uC73C\uB85C \uC720\uC0AC\uD55C ${a.members.length}\uAC1C \uB178\uD2B8 (\uC751\uC9D1\uB3C4: ${(a.coherenceScore*100).toFixed(0)}%)`,priority:this.calculatePriority(a),suggestedType:"framework"})}}return this.sortAndLimit(r,i)}async suggestAll(t,e){var a;let s=(a=e==null?void 0:e.maxSuggestions)!=null?a:10,[i,n,r]=await Promise.all([this.suggestByTags({...e,maxSuggestions:5}),this.suggestByFolders({...e,maxSuggestions:3}),this.suggestBySimilarity(t,{...e,maxSuggestions:3})]),o=this.deduplicateSuggestions([...i,...n,...r]);return this.sortAndLimit(o,s)}calculatePriority(t){let e=t.coherenceScore*Math.min(t.members.length/10,1);return e>=.6?"high":e>=.3?"medium":"low"}suggestSynthesisType(t){let e=t.members.length;return e>=7?"framework":e>=4?"comparison":"summary"}sortAndLimit(t,e){let s={high:3,medium:2,low:1};return t.sort((i,n)=>{let r=s[n.priority]-s[i.priority];return r!==0?r:n.cluster.coherenceScore-i.cluster.coherenceScore}).slice(0,e)}deduplicateSuggestions(t){let e=new Set;return t.filter(s=>{let i=s.cluster.members.map(n=>n.noteId).sort().join(",");return e.has(i)?!1:(e.add(i),!0)})}};var O=require("obsidian"),N=class{constructor(t){this.apiKey=t;this.model="text-embedding-3-small";this.dimensions=1536}async embed(t){if(!this.isAvailable())throw new Error("OpenAI API key is not configured");let e=await(0,O.requestUrl)({url:"https://api.openai.com/v1/embeddings",method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:this.truncateText(t)})});if(e.status!==200)throw new Error(`OpenAI API error: ${e.status}`);return e.json.data[0].embedding}async embedBatch(t){if(!this.isAvailable())throw new Error("OpenAI API key is not configured");if(t.length===0)return[];let e=t.map(r=>this.truncateText(r)),s=await(0,O.requestUrl)({url:"https://api.openai.com/v1/embeddings",method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:e})});if(s.status!==200)throw new Error(`OpenAI API error: ${s.status}`);return[...s.json.data].sort((r,o)=>r.index-o.index).map(r=>r.embedding)}isAvailable(){return!!this.apiKey&&this.apiKey.length>0}getDimensions(){return this.dimensions}truncateText(t){return t.length<=3e4?t:t.substring(0,3e4)}};var P=class{constructor(){this.vectors=new Map}store(t){this.vectors.set(t.noteId,t)}get(t){return this.vectors.get(t)}search(t,e){let{limit:s=10,threshold:i=.3,excludeNoteIds:n=[]}=e||{},r=[];for(let[o,a]of this.vectors){if(n.includes(o))continue;let l=this.cosineSimilarity(t,a.vector);l>=i&&r.push({noteId:o,notePath:a.notePath,similarity:l})}return r.sort((o,a)=>a.similarity-o.similarity).slice(0,s)}getStoredNoteIds(){return Array.from(this.vectors.keys())}remove(t){this.vectors.delete(t)}clear(){this.vectors.clear()}size(){return this.vectors.size}cosineSimilarity(t,e){if(t.length!==e.length)throw new Error("Vectors must have the same dimensions");let s=0,i=0,n=0;for(let o=0;o<t.length;o++)s+=t[o]*e[o],i+=t[o]*t[o],n+=e[o]*e[o];let r=Math.sqrt(i)*Math.sqrt(n);return r===0?0:s/r}};var L=require("obsidian");function z(c,t,e,s,i,n=[]){return{id:`result_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,requestId:c,title:t,content:e,sourceNoteLinks:s,suggestedTags:n,synthesisType:i,createdAt:new Date}}var G={openai:"gpt-4o-mini",anthropic:"claude-3-5-haiku-latest"},T=class{constructor(t){this.config=t;this.model=t.model||G[t.provider]}async generate(t,e){let s=this.buildPrompt(t,e),i=await this.callLLM(s),n=[];t.options.autoSuggestTags&&(n=await this.suggestTags(i,e));let r=e.map(o=>`[[${o.title}]]`);return z(t.id,t.targetTitle||"\uC885\uD569 \uB178\uD2B8",i,r,t.synthesisType,n)}async suggestTitle(t){let e=this.buildTitlePrompt(t);return(await this.callLLM(e)).trim().replace(/^["']|["']$/g,"")}async suggestType(t){let s=`\uB2E4\uC74C \uB178\uD2B8\uB4E4\uC744 \uBD84\uC11D\uD558\uACE0 \uAC00\uC7A5 \uC801\uD569\uD55C \uD569\uC131 \uD0C0\uC785\uC744 \uD558\uB098\uB9CC \uC120\uD0DD\uD574\uC11C \uADF8 \uD0C0\uC785\uBA85\uB9CC \uBC18\uD658\uD574.

\uB178\uD2B8 \uBAA9\uB85D: ${t.map(r=>r.title).join(", ")}

\uD569\uC131 \uD0C0\uC785:
- framework: \uC5EC\uB7EC \uAC1C\uB150\uC744 \uC885\uD569\uD558\uC5EC \uD558\uB098\uC758 \uD504\uB808\uC784\uC6CC\uD06C\uB85C \uAD6C\uC870\uD654
- summary: \uD575\uC2EC \uB0B4\uC6A9\uC744 \uC694\uC57D
- comparison: \uB178\uD2B8\uB4E4 \uAC04\uC758 \uBE44\uAD50 \uBD84\uC11D
- timeline: \uC2DC\uAC04\uC21C \uC815\uB9AC

\uC751\uB2F5\uC740 framework, summary, comparison, timeline \uC911 \uD558\uB098\uB9CC.`,n=(await this.callLLM(s)).trim().toLowerCase();return["framework","summary","comparison","timeline"].includes(n)?n:"framework"}isAvailable(){return!!this.config.apiKey&&this.config.apiKey.length>0}buildPrompt(t,e){let s=this.getTypeInstructions(t.synthesisType),i=t.options.language==="ko"?"\uD55C\uAD6D\uC5B4":"English",n=e.map(r=>`## ${r.title}

${r.content}`).join(`

---

`);return`\uB2F9\uC2E0\uC740 PKM(\uAC1C\uC778 \uC9C0\uC2DD \uAD00\uB9AC) \uC804\uBB38\uAC00\uC785\uB2C8\uB2E4. \uB2E4\uC74C \uB178\uD2B8\uB4E4\uC744 \uBD84\uC11D\uD558\uACE0 ${s}

## \uC9C0\uCE68
- \uC5B8\uC5B4: ${i}
- \uC6D0\uBCF8 \uB178\uD2B8\uC758 \uD575\uC2EC \uC778\uC0AC\uC774\uD2B8\uB97C \uBCF4\uC874\uD558\uC138\uC694
- \uC0C8\uB85C\uC6B4 \uC5F0\uACB0\uACFC \uD328\uD134\uC744 \uBC1C\uACAC\uD558\uC138\uC694
- \uB9C8\uD06C\uB2E4\uC6B4 \uD615\uC2DD\uC73C\uB85C \uC791\uC131\uD558\uC138\uC694
${t.options.includeBacklinks?"- \uC6D0\uBCF8 \uB178\uD2B8\uB85C\uC758 \uC5ED\uB9C1\uD06C([[\uB178\uD2B8\uBA85]])\uB97C \uC801\uC808\uD788 \uD3EC\uD568\uD558\uC138\uC694":""}

## \uC6D0\uBCF8 \uB178\uD2B8\uB4E4

${n}

## \uD569\uC131 \uACB0\uACFC`}getTypeInstructions(t){return{framework:"\uD558\uB098\uC758 \uC885\uD569\uC801\uC778 \uD504\uB808\uC784\uC6CC\uD06C\uB85C \uAD6C\uC870\uD654\uD558\uC138\uC694. \uD575\uC2EC \uAC1C\uB150\uB4E4 \uAC04\uC758 \uAD00\uACC4\uB97C \uBA85\uD655\uD788 \uD558\uACE0, \uC0C1\uC704 \uC218\uC900\uC758 \uD1B5\uD569 \uC778\uC0AC\uC774\uD2B8\uB97C \uB3C4\uCD9C\uD558\uC138\uC694.",summary:"\uD575\uC2EC \uB0B4\uC6A9\uC744 \uAC04\uACB0\uD558\uAC8C \uC694\uC57D\uD558\uC138\uC694. \uAC01 \uB178\uD2B8\uC758 \uC8FC\uC694 \uD3EC\uC778\uD2B8\uB97C \uCD94\uCD9C\uD558\uACE0 \uD1B5\uD569\uD558\uC138\uC694.",comparison:"\uB178\uD2B8\uB4E4 \uAC04\uC758 \uC720\uC0AC\uC810\uACFC \uCC28\uC774\uC810\uC744 \uBD84\uC11D\uD558\uC138\uC694. \uD45C\uB098 \uAD6C\uC870\uD654\uB41C \uBE44\uAD50\uB97C \uD65C\uC6A9\uD558\uC138\uC694.",timeline:"\uC2DC\uAC04\uC21C\uC73C\uB85C \uC815\uB9AC\uD558\uC138\uC694. \uBC1C\uC804 \uACFC\uC815\uC774\uB098 \uBCC0\uD654\uB97C \uAC15\uC870\uD558\uC138\uC694."}[t]}buildTitlePrompt(t){return`\uB2E4\uC74C \uB178\uD2B8\uB4E4\uC744 \uC885\uD569\uD55C \uD569\uC131 \uB178\uD2B8\uC758 \uC81C\uBAA9\uC744 \uC81C\uC548\uD574\uC8FC\uC138\uC694.
\uAC04\uACB0\uD558\uACE0 \uD575\uC2EC\uC744 \uB2F4\uC740 \uC81C\uBAA9\uC73C\uB85C, \uB530\uC634\uD45C \uC5C6\uC774 \uC81C\uBAA9\uB9CC \uBC18\uD658\uD558\uC138\uC694.

\uB178\uD2B8 \uBAA9\uB85D: ${t.map(s=>s.title).join(", ")}

\uC81C\uC548 \uC81C\uBAA9:`}async suggestTags(t,e){let s=new Set;for(let r of e)for(let o of r.tags)s.add(o);let i=new Map;for(let r of e)for(let o of r.tags)i.set(o,(i.get(o)||0)+1);let n=[];for(let[r,o]of i)o>=2&&n.push(r);return n.slice(0,5)}async callLLM(t){return this.config.provider==="openai"?this.callOpenAI(t):this.callAnthropic(t)}async callOpenAI(t){let e=await(0,L.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:[{role:"user",content:t}],temperature:.7,max_tokens:4e3})});if(e.status!==200)throw new Error(`OpenAI API error: ${e.status}`);return e.json.choices[0].message.content}async callAnthropic(t){let e=await(0,L.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",headers:{"x-api-key":this.config.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify({model:this.model,max_tokens:4e3,messages:[{role:"user",content:t}]})});if(e.status!==200)throw new Error(`Anthropic API error: ${e.status}`);return e.json.content[0].text}};var I=class{constructor(t){this.app=t}async getNote(t){let s=this.app.vault.getMarkdownFiles().find(i=>i.basename===t);return s?this.fileToNoteContent(s):null}async getNoteByPath(t){let e=this.app.vault.getFileByPath(t);return e?this.fileToNoteContent(e):null}async getNotesByTag(t){let e=[],s=this.app.vault.getMarkdownFiles();for(let i of s){let n=this.app.metadataCache.getFileCache(i);if(this.hasTag(n,t)){let r=await this.fileToNoteContent(i);r&&e.push(r)}}return e}async getNotesByFolder(t){var i;let e=[],s=this.app.vault.getMarkdownFiles();for(let n of s){let r=((i=n.parent)==null?void 0:i.path)||"";if(r===t||r.startsWith(t+"/")){let o=await this.fileToNoteContent(n);o&&e.push(o)}}return e}async getAllNotes(){let t=[],e=this.app.vault.getMarkdownFiles();for(let s of e){let i=await this.fileToNoteContent(s);i&&t.push(i)}return t}async createNote(t,e){let s=t.substring(0,t.lastIndexOf("/"));s&&(this.app.vault.getAbstractFileByPath(s)||await this.app.vault.createFolder(s)),await this.app.vault.create(t,e)}async updateNote(t,e){let s=this.app.vault.getFileByPath(t);s&&await this.app.vault.modify(s,e)}async getAllTags(){var s;let t=new Set,e=this.app.vault.getMarkdownFiles();for(let i of e){let n=this.app.metadataCache.getFileCache(i);if(n!=null&&n.tags)for(let r of n.tags)t.add(r.tag.replace(/^#/,""));if((s=n==null?void 0:n.frontmatter)!=null&&s.tags){let r=n.frontmatter.tags;if(Array.isArray(r))for(let o of r)t.add(String(o).replace(/^#/,""))}}return Array.from(t).sort()}async getAllFolders(){var s;let t=new Set,e=this.app.vault.getMarkdownFiles();for(let i of e){let n=(s=i.parent)==null?void 0:s.path;n&&n!=="/"&&t.add(n)}return Array.from(t).sort()}async fileToNoteContent(t){var e,s;try{let i=await this.app.vault.cachedRead(t),n=this.app.metadataCache.getFileCache(t),r=[];if(n!=null&&n.tags)for(let a of n.tags)r.push(a.tag.replace(/^#/,""));if((e=n==null?void 0:n.frontmatter)!=null&&e.tags){let a=n.frontmatter.tags;if(Array.isArray(a))for(let l of a)r.push(String(l).replace(/^#/,""))}let o=this.extractBody(i);return{noteId:t.basename,notePath:t.path,title:((s=n==null?void 0:n.frontmatter)==null?void 0:s.title)||t.basename,content:o,tags:[...new Set(r)]}}catch(i){return console.error(`Error reading file ${t.path}:`,i),null}}extractBody(t){let e=/^---\n[\s\S]*?\n---\n*/;return t.replace(e,"").trim()}hasTag(t,e){var s;if(!t)return!1;if(t.tags)for(let i of t.tags){let n=i.tag.replace(/^#/,"");if(n===e||n.startsWith(e+"/"))return!0}if((s=t.frontmatter)!=null&&s.tags){let i=t.frontmatter.tags;if(Array.isArray(i))for(let n of i){let r=String(n).replace(/^#/,"");if(r===e||r.startsWith(e+"/"))return!0}}return!1}};var R={openaiApiKey:"",anthropicApiKey:"",llmProvider:"openai",model:void 0,outputFolder:"Synthesized",defaultSynthesisOptions:{includeBacklinks:!0,autoSuggestTags:!0,language:"ko"},clusterOptions:{minClusterSize:3,minCoherence:.4,maxSuggestions:5}};var u=require("obsidian"),x=class extends u.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Knowledge Synthesizer Settings"}),t.createEl("h3",{text:"API Keys"}),new u.Setting(t).setName("OpenAI API Key").setDesc("\uC784\uBCA0\uB529 \uBC0F \uD569\uC131\uC5D0 \uC0AC\uC6A9\uB418\uB294 OpenAI API \uD0A4").addText(e=>e.setPlaceholder("sk-...").setValue(this.plugin.settings.openaiApiKey).onChange(async s=>{this.plugin.settings.openaiApiKey=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Anthropic API Key").setDesc("Claude\uB97C \uC0AC\uC6A9\uD55C \uD569\uC131\uC6A9 Anthropic API \uD0A4").addText(e=>e.setPlaceholder("sk-ant-...").setValue(this.plugin.settings.anthropicApiKey).onChange(async s=>{this.plugin.settings.anthropicApiKey=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("LLM Provider").setDesc("\uD569\uC131\uC5D0 \uC0AC\uC6A9\uD560 LLM \uD504\uB85C\uBC14\uC774\uB354").addDropdown(e=>e.addOption("openai","OpenAI").addOption("anthropic","Anthropic (Claude)").setValue(this.plugin.settings.llmProvider).onChange(async s=>{this.plugin.settings.llmProvider=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Model").setDesc("\uC0AC\uC6A9\uD560 \uBAA8\uB378 (\uBE44\uC6CC\uB450\uBA74 \uAE30\uBCF8\uAC12 \uC0AC\uC6A9)").addText(e=>e.setPlaceholder("gpt-4o-mini \uB610\uB294 claude-3-5-haiku-latest").setValue(this.plugin.settings.model||"").onChange(async s=>{this.plugin.settings.model=s||void 0,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Output"}),new u.Setting(t).setName("Output Folder").setDesc("\uD569\uC131\uB41C \uB178\uD2B8\uAC00 \uC800\uC7A5\uB420 \uD3F4\uB354").addText(e=>e.setPlaceholder("Synthesized").setValue(this.plugin.settings.outputFolder).onChange(async s=>{this.plugin.settings.outputFolder=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Synthesis Options"}),new u.Setting(t).setName("Include Backlinks").setDesc("\uD569\uC131 \uACB0\uACFC\uC5D0 \uC6D0\uBCF8 \uB178\uD2B8\uB85C\uC758 \uC5ED\uB9C1\uD06C \uD3EC\uD568").addToggle(e=>e.setValue(this.plugin.settings.defaultSynthesisOptions.includeBacklinks).onChange(async s=>{this.plugin.settings.defaultSynthesisOptions.includeBacklinks=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Auto Suggest Tags").setDesc("AI\uAC00 \uC790\uB3D9\uC73C\uB85C \uD0DC\uADF8 \uC81C\uC548").addToggle(e=>e.setValue(this.plugin.settings.defaultSynthesisOptions.autoSuggestTags).onChange(async s=>{this.plugin.settings.defaultSynthesisOptions.autoSuggestTags=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Default Language").setDesc("\uC0DD\uC131\uB418\uB294 \uB178\uD2B8\uC758 \uAE30\uBCF8 \uC5B8\uC5B4").addDropdown(e=>e.addOption("ko","\uD55C\uAD6D\uC5B4").addOption("en","English").setValue(this.plugin.settings.defaultSynthesisOptions.language).onChange(async s=>{this.plugin.settings.defaultSynthesisOptions.language=s,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Cluster Options"}),new u.Setting(t).setName("Minimum Cluster Size").setDesc("\uD569\uC131 \uCD94\uCC9C\uC5D0 \uD544\uC694\uD55C \uCD5C\uC18C \uB178\uD2B8 \uC218").addSlider(e=>e.setLimits(2,10,1).setValue(this.plugin.settings.clusterOptions.minClusterSize).setDynamicTooltip().onChange(async s=>{this.plugin.settings.clusterOptions.minClusterSize=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Minimum Coherence").setDesc("\uD569\uC131 \uCD94\uCC9C\uC5D0 \uD544\uC694\uD55C \uCD5C\uC18C \uC751\uC9D1\uB3C4 (0.0 - 1.0)").addSlider(e=>e.setLimits(.1,.9,.1).setValue(this.plugin.settings.clusterOptions.minCoherence).setDynamicTooltip().onChange(async s=>{this.plugin.settings.clusterOptions.minCoherence=s,await this.plugin.saveSettings()})),new u.Setting(t).setName("Max Suggestions").setDesc("\uD45C\uC2DC\uD560 \uCD5C\uB300 \uCD94\uCC9C \uC218").addSlider(e=>e.setLimits(3,15,1).setValue(this.plugin.settings.clusterOptions.maxSuggestions).setDynamicTooltip().onChange(async s=>{this.plugin.settings.clusterOptions.maxSuggestions=s,await this.plugin.saveSettings()}))}};var h=require("obsidian"),f="knowledge-synthesizer-view",y=class extends h.ItemView{constructor(e,s){super(e);this.suggestions=[];this.isLoading=!1;this.plugin=s}getViewType(){return f}getDisplayText(){return"Knowledge Synthesizer"}getIcon(){return"layers"}async onOpen(){await this.render()}async onClose(){}async render(){let e=this.containerEl.children[1];if(e.empty(),e.addClass("synthesis-view-container"),e.createDiv({cls:"synthesis-view-header"}).createEl("h4",{text:"Knowledge Synthesizer"}),!this.plugin.isConfigured()){let o=e.createDiv({cls:"synthesis-warning"});o.createEl("p",{text:"\u26A0\uFE0F API \uD0A4\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4."}),o.createEl("p",{text:"\uC124\uC815\uC5D0\uC11C OpenAI API \uD0A4\uB97C \uC785\uB825\uD558\uC138\uC694."});return}if(e.createDiv({cls:"synthesis-actions"}).createEl("button",{text:"\uCD94\uCC9C \uC0C8\uB85C\uACE0\uCE68"}).addEventListener("click",()=>this.loadSuggestions()),this.isLoading){e.createDiv({cls:"synthesis-loading"}).createEl("p",{text:"\uBD84\uC11D \uC911..."});return}if(this.suggestions.length===0){let o=e.createDiv({cls:"synthesis-empty"});o.createEl("p",{text:"\uD569\uC131 \uAC00\uB2A5\uD55C \uD074\uB7EC\uC2A4\uD130\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4."}),o.createEl("p",{text:"\uB178\uD2B8\uB97C \uCD94\uAC00\uD558\uAC70\uB098 \uD0DC\uADF8\uB97C \uC0AC\uC6A9\uD574\uBCF4\uC138\uC694."});return}let r=e.createDiv({cls:"synthesis-suggestions"});for(let o of this.suggestions)this.renderSuggestion(r,o)}renderSuggestion(e,s){let i=e.createDiv({cls:"synthesis-suggestion-card"}),n=i.createDiv({cls:"suggestion-header"}),r=n.createSpan({cls:`priority-icon priority-${s.priority}`});(0,h.setIcon)(r,this.getPriorityIcon(s.priority)),n.createEl("span",{text:s.cluster.name,cls:"suggestion-title"});let o=i.createDiv({cls:"suggestion-info"});o.createEl("span",{text:`${s.cluster.members.length}\uAC1C \uB178\uD2B8`}),o.createEl("span",{text:`\uC751\uC9D1\uB3C4: ${(s.cluster.coherenceScore*100).toFixed(0)}%`}),i.createEl("p",{text:s.reason,cls:"suggestion-reason"});let a=i.createDiv({cls:"suggestion-notes"}),l=a.createEl("button",{text:"\uB178\uD2B8 \uBAA9\uB85D \uBCF4\uAE30",cls:"toggle-notes"}),g=a.createDiv({cls:"note-list-content hidden"});for(let m of s.cluster.members.slice(0,10))g.createEl("div",{text:`\u2022 ${m.title}`,cls:"note-item"});s.cluster.members.length>10&&g.createEl("div",{text:`... \uADF8 \uC678 ${s.cluster.members.length-10}\uAC1C`,cls:"note-item more"}),l.addEventListener("click",()=>{g.classList.toggle("hidden"),l.textContent=g.classList.contains("hidden")?"\uB178\uD2B8 \uBAA9\uB85D \uBCF4\uAE30":"\uB178\uD2B8 \uBAA9\uB85D \uC228\uAE30\uAE30"});let d=i.createDiv({cls:"suggestion-actions"}),S=d.createEl("select",{cls:"synthesis-type-select"}),F=[{value:"framework",label:"\uC885\uD569 \uD504\uB808\uC784\uC6CC\uD06C"},{value:"summary",label:"\uC694\uC57D"},{value:"comparison",label:"\uBE44\uAD50 \uBD84\uC11D"},{value:"timeline",label:"\uD0C0\uC784\uB77C\uC778"}];for(let m of F){let D=S.createEl("option",{value:m.value,text:m.label});m.value===s.suggestedType&&(D.selected=!0)}d.createEl("button",{text:"\uD569\uC131\uD558\uAE30",cls:"mod-cta"}).addEventListener("click",async()=>{let m=S.value;await this.synthesize(s,m)})}getPriorityIcon(e){switch(e){case"high":return"star";case"medium":return"circle";default:return"circle-dot"}}async loadSuggestions(){if(!this.plugin.suggestSynthesisUseCase){new h.Notice("\uC11C\uBE44\uC2A4\uAC00 \uCD08\uAE30\uD654\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.");return}this.isLoading=!0,await this.render();try{let e=this.app.workspace.getActiveFile(),s=[];e&&s.push(e.basename);let i=this.app.vault.getMarkdownFiles().slice(0,5);for(let n of i)s.includes(n.basename)||s.push(n.basename);this.suggestions=await this.plugin.suggestSynthesisUseCase.suggestAll(s,{minClusterSize:this.plugin.settings.clusterOptions.minClusterSize,minCoherence:this.plugin.settings.clusterOptions.minCoherence,maxSuggestions:this.plugin.settings.clusterOptions.maxSuggestions})}catch(e){console.error("Failed to load suggestions:",e),new h.Notice("\uCD94\uCC9C \uB85C\uB4DC \uC2E4\uD328: "+(e instanceof Error?e.message:String(e)))}finally{this.isLoading=!1,await this.render()}}async synthesize(e,s){if(!this.plugin.synthesizeNotesUseCase){new h.Notice("\uC11C\uBE44\uC2A4\uAC00 \uCD08\uAE30\uD654\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.");return}new h.Notice("\uD569\uC131 \uC911...");try{let{result:i}=await this.plugin.synthesizeNotesUseCase.execute({cluster:e.cluster,synthesisType:s,options:this.plugin.settings.defaultSynthesisOptions}),n=await this.plugin.synthesizeNotesUseCase.saveResult(i,this.plugin.settings.outputFolder);new h.Notice(`\uD569\uC131 \uC644\uB8CC: ${i.title}`);let r=this.app.vault.getFileByPath(n);r&&await this.app.workspace.getLeaf().openFile(r)}catch(i){console.error("Synthesis failed:",i),new h.Notice("\uD569\uC131 \uC2E4\uD328: "+(i instanceof Error?i.message:String(i)))}}};var A=class extends $.Plugin{constructor(){super(...arguments);this.embeddingProvider=null;this.vectorStore=null;this.synthesisGenerator=null;this.noteRepository=null;this.embeddingService=null;this.clusterNotesUseCase=null;this.synthesizeNotesUseCase=null;this.suggestSynthesisUseCase=null}async onload(){console.log("Loading Knowledge Synthesizer Plugin"),await this.loadSettings(),this.initializeServices(),this.registerView(f,e=>new y(e,this)),this.addCommand({id:"open-synthesis-view",name:"Open Synthesis View",callback:()=>this.activateView()}),this.addCommand({id:"synthesize-current-tag",name:"Synthesize notes with current note's primary tag",callback:()=>this.synthesizeCurrentTag()}),this.addSettingTab(new x(this.app,this)),this.addRibbonIcon("layers","Knowledge Synthesizer",()=>this.activateView())}async onunload(){var e;console.log("Unloading Knowledge Synthesizer Plugin"),(e=this.vectorStore)==null||e.clear()}async loadSettings(){this.settings=Object.assign({},R,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.initializeServices()}isConfigured(){return!!this.settings.openaiApiKey}initializeServices(){if(!this.settings.openaiApiKey){console.log("Knowledge Synthesizer: OpenAI API key not configured");return}try{this.noteRepository=new I(this.app),this.embeddingProvider=new N(this.settings.openaiApiKey),this.vectorStore=new P,this.embeddingService=new v(this.embeddingProvider,this.vectorStore);let e=this.settings.llmProvider==="anthropic"?this.settings.anthropicApiKey:this.settings.openaiApiKey,s={provider:this.settings.llmProvider,apiKey:e,model:this.settings.model};this.synthesisGenerator=new T(s),this.clusterNotesUseCase=new w(this.embeddingService,this.noteRepository),this.synthesizeNotesUseCase=new b(this.synthesisGenerator,this.noteRepository),this.suggestSynthesisUseCase=new C(this.clusterNotesUseCase,this.noteRepository),console.log("Knowledge Synthesizer: Services initialized")}catch(e){console.error("Failed to initialize services:",e)}}async activateView(){let{workspace:e}=this.app,s=e.getLeavesOfType(f)[0];if(!s){let i=e.getRightLeaf(!1);i&&(s=i,await s.setViewState({type:f,active:!0}))}if(s){e.revealLeaf(s);let i=s.view;i instanceof y&&await i.loadSuggestions()}}async synthesizeCurrentTag(){let e=this.app.workspace.getActiveFile();if(!e)return;let s=this.app.metadataCache.getFileCache(e);if(!(s!=null&&s.tags)||s.tags.length===0)return;let i=s.tags[0].tag.replace(/^#/,"");if(!(!this.clusterNotesUseCase||!this.synthesizeNotesUseCase))try{let n=await this.clusterNotesUseCase.clusterByTag(i);if(n.members.length<2)return;let{result:r}=await this.synthesizeNotesUseCase.execute({cluster:n,synthesisType:"framework",options:this.settings.defaultSynthesisOptions});await this.synthesizeNotesUseCase.saveResult(r,this.settings.outputFolder)}catch(n){console.error("Failed to synthesize:",n)}}};
