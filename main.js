/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var E=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var G=Object.prototype.hasOwnProperty;var U=(l,t)=>{for(var e in t)E(l,e,{get:t[e],enumerable:!0})},_=(l,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of B(t))!G.call(l,i)&&i!==e&&E(l,i,{get:()=>t[i],enumerable:!(s=V(t,i))||s.enumerable});return l};var j=l=>_(E({},"__esModule",{value:!0}),l);var J={};U(J,{default:()=>O});module.exports=j(J);var D=require("obsidian");var u={claude:{id:"claude",name:"Claude",displayName:"Anthropic Claude",endpoint:"https://api.anthropic.com/v1",defaultModel:"claude-sonnet-4-5-20250929",apiKeyPrefix:"sk-ant-"},openai:{id:"openai",name:"OpenAI",displayName:"OpenAI GPT",endpoint:"https://api.openai.com/v1",defaultModel:"gpt-5.2",apiKeyPrefix:"sk-"},gemini:{id:"gemini",name:"Gemini",displayName:"Google Gemini",endpoint:"https://generativelanguage.googleapis.com/v1beta",defaultModel:"gemini-3-flash-preview",apiKeyPrefix:"AIza"},grok:{id:"grok",name:"Grok",displayName:"xAI Grok",endpoint:"https://api.x.ai/v1",defaultModel:"grok-4-1-fast"}},q={"claude-sonnet-4-5-20250929":{id:"claude-sonnet-4-5-20250929",displayName:"Claude Sonnet 4.5",provider:"claude",maxTokens:16384,inputCostPer1M:3,outputCostPer1M:15},"claude-opus-4-5-20251101":{id:"claude-opus-4-5-20251101",displayName:"Claude Opus 4.5",provider:"claude",maxTokens:32768,inputCostPer1M:15,outputCostPer1M:75},"claude-3-5-haiku-20241022":{id:"claude-3-5-haiku-20241022",displayName:"Claude 3.5 Haiku",provider:"claude",maxTokens:8192,inputCostPer1M:.8,outputCostPer1M:4},"gpt-5.2":{id:"gpt-5.2",displayName:"GPT-5.2",provider:"openai",maxTokens:32768,inputCostPer1M:1.75,outputCostPer1M:14},"gpt-4o-mini":{id:"gpt-4o-mini",displayName:"GPT-4o Mini",provider:"openai",maxTokens:16384,inputCostPer1M:.15,outputCostPer1M:.6},"gemini-3-flash-preview":{id:"gemini-3-flash-preview",displayName:"Gemini 3 Flash",provider:"gemini",maxTokens:65536,inputCostPer1M:.5,outputCostPer1M:3},"gemini-3-pro-preview":{id:"gemini-3-pro-preview",displayName:"Gemini 3 Pro",provider:"gemini",maxTokens:65536,inputCostPer1M:2.5,outputCostPer1M:10},"gemini-2.0-flash":{id:"gemini-2.0-flash",displayName:"Gemini 2.0 Flash",provider:"gemini",maxTokens:8192,inputCostPer1M:.075,outputCostPer1M:.3},"grok-4-1-fast":{id:"grok-4-1-fast",displayName:"Grok 4.1 Fast",provider:"grok",maxTokens:16384,inputCostPer1M:3,outputCostPer1M:15},"grok-4-1-fast-non-reasoning":{id:"grok-4-1-fast-non-reasoning",displayName:"Grok 4.1 Fast (Non-Reasoning)",provider:"grok",maxTokens:16384,inputCostPer1M:.6,outputCostPer1M:4}};function R(l){return Object.values(q).filter(t=>t.provider===l)}var C=class{constructor(t,e){this.embeddingProvider=t;this.vectorStore=e}async embedNote(t){let{noteId:e,notePath:s,content:i}=t;if(this.vectorStore.get(e))return;let n=await this.embeddingProvider.embed(i),o={noteId:e,notePath:s,vector:n,content:i.substring(0,500)};this.vectorStore.store(o)}async embedNotes(t,e){let s=t.filter(o=>!this.vectorStore.get(o.noteId));if(s.length===0)return;let i=10,n=0;for(let o=0;o<s.length;o+=i){let r=s.slice(o,o+i),a=r.map(g=>g.content),c=await this.embeddingProvider.embedBatch(a);for(let g=0;g<r.length;g++){let f=r[g],P={noteId:f.noteId,notePath:f.notePath,vector:c[g],content:f.content.substring(0,500)};this.vectorStore.store(P)}n+=r.length,e==null||e(n,s.length)}}async findSimilarByText(t,e){let s=await this.embeddingProvider.embed(t);return this.vectorStore.search(s,e)}findSimilarByNoteId(t,e){let s=this.vectorStore.get(t);if(!s)return[];let i={...e,excludeNoteIds:[...(e==null?void 0:e.excludeNoteIds)||[],t]};return this.vectorStore.search(s.vector,i)}hasEmbedding(t){return!!this.vectorStore.get(t)}getStats(){return{totalNotes:this.vectorStore.size()}}isAvailable(){return this.embeddingProvider.isAvailable()}clear(){this.vectorStore.clear()}};function m(l,t,e,s=0,i){return{id:`cluster_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,name:l,members:t,centroidVector:i,coherenceScore:s,source:e,createdAt:new Date}}var b=class{constructor(t,e){this.embeddingService=t;this.noteRepository=e}async clusterByTag(t){let e=await this.noteRepository.getNotesByTag(t);if(e.length===0)return m(`#${t}`,[],"tag",0);await this.embedNotes(e);let s=this.createMembers(e),i=await this.calculateCoherence(e);return m(`#${t}`,s,"tag",i)}async clusterByFolder(t){let e=await this.noteRepository.getNotesByFolder(t);if(e.length===0)return m(t,[],"folder",0);await this.embedNotes(e);let s=this.createMembers(e),i=await this.calculateCoherence(e);return m(t,s,"folder",i)}async autoCluster(t,e=.5,s=20){let i=await this.noteRepository.getNote(t);if(!i)return m("Unknown",[],"similarity",0);await this.embeddingService.embedNote({noteId:i.noteId,notePath:i.notePath,content:`${i.title}

${i.content}`});let n=this.embeddingService.findSimilarByNoteId(t,{threshold:e,limit:s-1}),o=[i];for(let c of n){let g=await this.noteRepository.getNoteByPath(c.notePath);g&&o.push(g)}let r=[{noteId:i.noteId,notePath:i.notePath,title:i.title,similarity:1},...n.map(c=>({noteId:c.noteId,notePath:c.notePath,title:c.noteId,similarity:c.similarity}))],a=r.length>1?r.slice(1).reduce((c,g)=>c+g.similarity,0)/(r.length-1):1;return m(`Similar to: ${i.title}`,r,"similarity",a)}async createManualCluster(t,e){let s=[];for(let o of t){let r=await this.noteRepository.getNote(o);r&&s.push(r)}if(s.length===0)return m(e,[],"manual",0);await this.embedNotes(s);let i=this.createMembers(s),n=await this.calculateCoherence(s);return m(e,i,"manual",n)}async embedNotes(t){let e=t.map(s=>({noteId:s.noteId,notePath:s.notePath,content:`${s.title}

${s.content}`}));await this.embeddingService.embedNotes(e)}createMembers(t){return t.map(e=>({noteId:e.noteId,notePath:e.notePath,title:e.title,similarity:1}))}async calculateCoherence(t){if(t.length<2)return 1;let e=0,s=0;for(let i=0;i<t.length;i++){let n=this.embeddingService.findSimilarByNoteId(t[i].noteId,{limit:t.length-1});for(let o of n)t.some(r=>r.noteId===o.noteId)&&(e+=o.similarity,s++)}return s>0?e/s:0}};var W={includeBacklinks:!0,autoSuggestTags:!0,language:"ko"};function z(l,t="framework",e={}){return{id:H(),sourceNoteIds:l,synthesisType:t,options:{...W,...e},createdAt:new Date}}function H(){return`syn_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}var N=class{constructor(t,e){this.synthesisGenerator=t;this.noteRepository=e}async execute(t){let{cluster:e,synthesisType:s,targetTitle:i,options:n}=t,o=e.members.map(g=>g.noteId);if(o.length===0)throw new Error("No notes to synthesize");let r=z(o,s,n);i?r.targetTitle=i:r.targetTitle=this.generateDefaultTitle(e,s);let a=await this.fetchNoteContents(o);if(a.length===0)throw new Error("Could not fetch any note contents");return{result:await this.synthesisGenerator.generate(r,a),request:r}}async saveResult(t,e){let s=this.sanitizeFileName(t.title),i=`${e}/${s}.md`,o=`${this.generateFrontmatter(t)}
${t.content}`;return await this.noteRepository.createNote(i,o),i}async fetchNoteContents(t){let e=[];for(let s of t){let i=await this.noteRepository.getNote(s);i&&e.push(i)}return e}generateDefaultTitle(t,e){let s={framework:"\uC885\uD569 \uD504\uB808\uC784\uC6CC\uD06C",summary:"\uC694\uC57D",comparison:"\uBE44\uAD50 \uBD84\uC11D",timeline:"\uD0C0\uC784\uB77C\uC778"};return`${t.name} - ${s[e]}`}sanitizeFileName(t){return t.replace(/[\\/:*?"<>|]/g,"").replace(/\s+/g," ").trim().substring(0,100)}generateFrontmatter(t){let e=["---",`title: "${t.title}"`,"type: synthesis",`synthesis_type: ${t.synthesisType}`,`created: ${t.createdAt.toISOString()}`,"sources:",...t.sourceNoteLinks.map(s=>`  - "${s}"`)];return t.suggestedTags.length>0&&(e.push("tags:"),e.push(...t.suggestedTags.map(s=>`  - "${s}"`))),e.push("---",""),e.join(`
`)}};var T=class{constructor(t,e){this.clusterNotesUseCase=t;this.noteRepository=e}async suggestByTags(t){let{minClusterSize:e=3,maxSuggestions:s=5,minCoherence:i=.4}=t||{},n=await this.noteRepository.getAllTags(),o=[];for(let r of n){let a=await this.clusterNotesUseCase.clusterByTag(r);a.members.length>=e&&a.coherenceScore>=i&&o.push({cluster:a,reason:`${a.members.length}\uAC1C\uC758 \uB178\uD2B8\uAC00 #${r} \uD0DC\uADF8\uB85C \uC5F0\uACB0\uB428 (\uC751\uC9D1\uB3C4: ${(a.coherenceScore*100).toFixed(0)}%)`,priority:this.calculatePriority(a),suggestedType:this.suggestSynthesisType(a)})}return this.sortAndLimit(o,s)}async suggestByFolders(t){let{minClusterSize:e=3,maxSuggestions:s=5,minCoherence:i=.3}=t||{},n=await this.noteRepository.getAllFolders(),o=[];for(let r of n){let a=await this.clusterNotesUseCase.clusterByFolder(r);a.members.length>=e&&a.coherenceScore>=i&&o.push({cluster:a,reason:`${a.members.length}\uAC1C\uC758 \uB178\uD2B8\uAC00 ${r} \uD3F4\uB354\uC5D0 \uC704\uCE58 (\uC751\uC9D1\uB3C4: ${(a.coherenceScore*100).toFixed(0)}%)`,priority:this.calculatePriority(a),suggestedType:this.suggestSynthesisType(a)})}return this.sortAndLimit(o,s)}async suggestBySimilarity(t,e){let{minClusterSize:s=3,maxSuggestions:i=5,minCoherence:n=.5}=e||{},o=[];for(let r of t){let a=await this.clusterNotesUseCase.autoCluster(r,.5,15);if(a.members.length>=s&&a.coherenceScore>=n){let c=a.members.find(g=>g.noteId===r);o.push({cluster:a,reason:`"${(c==null?void 0:c.title)||r}"\uC640 \uC758\uBBF8\uC801\uC73C\uB85C \uC720\uC0AC\uD55C ${a.members.length}\uAC1C \uB178\uD2B8 (\uC751\uC9D1\uB3C4: ${(a.coherenceScore*100).toFixed(0)}%)`,priority:this.calculatePriority(a),suggestedType:"framework"})}}return this.sortAndLimit(o,i)}async suggestAll(t,e){var a;let s=(a=e==null?void 0:e.maxSuggestions)!=null?a:10,[i,n,o]=await Promise.all([this.suggestByTags({...e,maxSuggestions:5}),this.suggestByFolders({...e,maxSuggestions:3}),this.suggestBySimilarity(t,{...e,maxSuggestions:3})]),r=this.deduplicateSuggestions([...i,...n,...o]);return this.sortAndLimit(r,s)}calculatePriority(t){let e=t.coherenceScore*Math.min(t.members.length/10,1);return e>=.6?"high":e>=.3?"medium":"low"}suggestSynthesisType(t){let e=t.members.length;return e>=7?"framework":e>=4?"comparison":"summary"}sortAndLimit(t,e){let s={high:3,medium:2,low:1};return t.sort((i,n)=>{let o=s[n.priority]-s[i.priority];return o!==0?o:n.cluster.coherenceScore-i.cluster.coherenceScore}).slice(0,e)}deduplicateSuggestions(t){let e=new Set;return t.filter(s=>{let i=s.cluster.members.map(n=>n.noteId).sort().join(",");return e.has(i)?!1:(e.add(i),!0)})}};var M=require("obsidian"),I=class{constructor(t){this.apiKey=t;this.model="text-embedding-3-small";this.dimensions=1536}async embed(t){if(!this.isAvailable())throw new Error("OpenAI API key is not configured");let e=await(0,M.requestUrl)({url:"https://api.openai.com/v1/embeddings",method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:this.truncateText(t)})});if(e.status!==200)throw new Error(`OpenAI API error: ${e.status}`);return e.json.data[0].embedding}async embedBatch(t){if(!this.isAvailable())throw new Error("OpenAI API key is not configured");if(t.length===0)return[];let e=t.map(o=>this.truncateText(o)),s=await(0,M.requestUrl)({url:"https://api.openai.com/v1/embeddings",method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,input:e})});if(s.status!==200)throw new Error(`OpenAI API error: ${s.status}`);return[...s.json.data].sort((o,r)=>o.index-r.index).map(o=>o.embedding)}isAvailable(){return!!this.apiKey&&this.apiKey.length>0}getDimensions(){return this.dimensions}truncateText(t){return t.length<=3e4?t:t.substring(0,3e4)}};var x=class{constructor(){this.vectors=new Map}store(t){this.vectors.set(t.noteId,t)}get(t){return this.vectors.get(t)}search(t,e){let{limit:s=10,threshold:i=.3,excludeNoteIds:n=[]}=e||{},o=[];for(let[r,a]of this.vectors){if(n.includes(r))continue;let c=this.cosineSimilarity(t,a.vector);c>=i&&o.push({noteId:r,notePath:a.notePath,similarity:c})}return o.sort((r,a)=>a.similarity-r.similarity).slice(0,s)}getStoredNoteIds(){return Array.from(this.vectors.keys())}remove(t){this.vectors.delete(t)}clear(){this.vectors.clear()}size(){return this.vectors.size}cosineSimilarity(t,e){if(t.length!==e.length)throw new Error("Vectors must have the same dimensions");let s=0,i=0,n=0;for(let r=0;r<t.length;r++)s+=t[r]*e[r],i+=t[r]*t[r],n+=e[r]*e[r];let o=Math.sqrt(i)*Math.sqrt(n);return o===0?0:s/o}};var h=require("obsidian");function K(l,t,e,s,i,n=[]){return{id:`result_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,requestId:l,title:t,content:e,sourceNoteLinks:s,suggestedTags:n,synthesisType:i,createdAt:new Date}}var S=class{constructor(t){this.config=t;this.model=t.model||u[t.provider].defaultModel}async generate(t,e){let s=this.buildPrompt(t,e),i=await this.callLLM(s),n=[];t.options.autoSuggestTags&&(n=await this.suggestTags(i,e));let o=e.map(r=>`[[${r.title}]]`);return K(t.id,t.targetTitle||"\uC885\uD569 \uB178\uD2B8",i,o,t.synthesisType,n)}async suggestTitle(t){let e=this.buildTitlePrompt(t);return(await this.callLLM(e)).trim().replace(/^["']|["']$/g,"")}async suggestType(t){let s=`\uB2E4\uC74C \uB178\uD2B8\uB4E4\uC744 \uBD84\uC11D\uD558\uACE0 \uAC00\uC7A5 \uC801\uD569\uD55C \uD569\uC131 \uD0C0\uC785\uC744 \uD558\uB098\uB9CC \uC120\uD0DD\uD574\uC11C \uADF8 \uD0C0\uC785\uBA85\uB9CC \uBC18\uD658\uD574.

\uB178\uD2B8 \uBAA9\uB85D: ${t.map(o=>o.title).join(", ")}

\uD569\uC131 \uD0C0\uC785:
- framework: \uC5EC\uB7EC \uAC1C\uB150\uC744 \uC885\uD569\uD558\uC5EC \uD558\uB098\uC758 \uD504\uB808\uC784\uC6CC\uD06C\uB85C \uAD6C\uC870\uD654
- summary: \uD575\uC2EC \uB0B4\uC6A9\uC744 \uC694\uC57D
- comparison: \uB178\uD2B8\uB4E4 \uAC04\uC758 \uBE44\uAD50 \uBD84\uC11D
- timeline: \uC2DC\uAC04\uC21C \uC815\uB9AC

\uC751\uB2F5\uC740 framework, summary, comparison, timeline \uC911 \uD558\uB098\uB9CC.`,n=(await this.callLLM(s)).trim().toLowerCase();return["framework","summary","comparison","timeline"].includes(n)?n:"framework"}isAvailable(){return!!this.config.apiKey&&this.config.apiKey.length>0}async testApiKey(t){try{switch(this.config.provider){case"claude":return await this.testClaudeApiKey(t);case"openai":return await this.testOpenAIApiKey(t);case"gemini":return await this.testGeminiApiKey(t);case"grok":return await this.testGrokApiKey(t);default:return!1}}catch(e){return!1}}async testClaudeApiKey(t){let e=await(0,h.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",headers:{"x-api-key":t,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:[{role:"user",content:"Hello"}],max_tokens:10})});return e.status===200&&e.json.content}async testOpenAIApiKey(t){var n;let e=this.model.startsWith("gpt-5")||this.model.startsWith("o1")||this.model.startsWith("o3"),s={model:this.model,messages:[{role:"user",content:"Hello"}]};e?s.max_completion_tokens=10:s.max_tokens=10;let i=await(0,h.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(s)});return i.status===200&&((n=i.json.choices)==null?void 0:n.length)>0}async testGeminiApiKey(t){var i;let e=`https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${t}`,s=await(0,h.requestUrl)({url:e,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:"Hello"}]}],generationConfig:{maxOutputTokens:10}})});return s.status===200&&((i=s.json.candidates)==null?void 0:i.length)>0}async testGrokApiKey(t){var s;let e=await(0,h.requestUrl)({url:"https://api.x.ai/v1/chat/completions",method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:[{role:"user",content:"Hello"}],max_tokens:10})});return e.status===200&&((s=e.json.choices)==null?void 0:s.length)>0}buildPrompt(t,e){let s=this.getTypeInstructions(t.synthesisType),i=t.options.language==="ko"?"\uD55C\uAD6D\uC5B4":"English",n=e.map(o=>`## ${o.title}

${o.content}`).join(`

---

`);return`\uB2F9\uC2E0\uC740 PKM(\uAC1C\uC778 \uC9C0\uC2DD \uAD00\uB9AC) \uC804\uBB38\uAC00\uC785\uB2C8\uB2E4. \uB2E4\uC74C \uB178\uD2B8\uB4E4\uC744 \uBD84\uC11D\uD558\uACE0 ${s}

## \uC9C0\uCE68
- \uC5B8\uC5B4: ${i}
- \uC6D0\uBCF8 \uB178\uD2B8\uC758 \uD575\uC2EC \uC778\uC0AC\uC774\uD2B8\uB97C \uBCF4\uC874\uD558\uC138\uC694
- \uC0C8\uB85C\uC6B4 \uC5F0\uACB0\uACFC \uD328\uD134\uC744 \uBC1C\uACAC\uD558\uC138\uC694
- \uB9C8\uD06C\uB2E4\uC6B4 \uD615\uC2DD\uC73C\uB85C \uC791\uC131\uD558\uC138\uC694
${t.options.includeBacklinks?"- \uC6D0\uBCF8 \uB178\uD2B8\uB85C\uC758 \uC5ED\uB9C1\uD06C([[\uB178\uD2B8\uBA85]])\uB97C \uC801\uC808\uD788 \uD3EC\uD568\uD558\uC138\uC694":""}

## \uC6D0\uBCF8 \uB178\uD2B8\uB4E4

${n}

## \uD569\uC131 \uACB0\uACFC`}getTypeInstructions(t){return{framework:"\uD558\uB098\uC758 \uC885\uD569\uC801\uC778 \uD504\uB808\uC784\uC6CC\uD06C\uB85C \uAD6C\uC870\uD654\uD558\uC138\uC694. \uD575\uC2EC \uAC1C\uB150\uB4E4 \uAC04\uC758 \uAD00\uACC4\uB97C \uBA85\uD655\uD788 \uD558\uACE0, \uC0C1\uC704 \uC218\uC900\uC758 \uD1B5\uD569 \uC778\uC0AC\uC774\uD2B8\uB97C \uB3C4\uCD9C\uD558\uC138\uC694.",summary:"\uD575\uC2EC \uB0B4\uC6A9\uC744 \uAC04\uACB0\uD558\uAC8C \uC694\uC57D\uD558\uC138\uC694. \uAC01 \uB178\uD2B8\uC758 \uC8FC\uC694 \uD3EC\uC778\uD2B8\uB97C \uCD94\uCD9C\uD558\uACE0 \uD1B5\uD569\uD558\uC138\uC694.",comparison:"\uB178\uD2B8\uB4E4 \uAC04\uC758 \uC720\uC0AC\uC810\uACFC \uCC28\uC774\uC810\uC744 \uBD84\uC11D\uD558\uC138\uC694. \uD45C\uB098 \uAD6C\uC870\uD654\uB41C \uBE44\uAD50\uB97C \uD65C\uC6A9\uD558\uC138\uC694.",timeline:"\uC2DC\uAC04\uC21C\uC73C\uB85C \uC815\uB9AC\uD558\uC138\uC694. \uBC1C\uC804 \uACFC\uC815\uC774\uB098 \uBCC0\uD654\uB97C \uAC15\uC870\uD558\uC138\uC694."}[t]}buildTitlePrompt(t){return`\uB2E4\uC74C \uB178\uD2B8\uB4E4\uC744 \uC885\uD569\uD55C \uD569\uC131 \uB178\uD2B8\uC758 \uC81C\uBAA9\uC744 \uC81C\uC548\uD574\uC8FC\uC138\uC694.
\uAC04\uACB0\uD558\uACE0 \uD575\uC2EC\uC744 \uB2F4\uC740 \uC81C\uBAA9\uC73C\uB85C, \uB530\uC634\uD45C \uC5C6\uC774 \uC81C\uBAA9\uB9CC \uBC18\uD658\uD558\uC138\uC694.

\uB178\uD2B8 \uBAA9\uB85D: ${t.map(s=>s.title).join(", ")}

\uC81C\uC548 \uC81C\uBAA9:`}async suggestTags(t,e){let s=new Set;for(let o of e)for(let r of o.tags)s.add(r);let i=new Map;for(let o of e)for(let r of o.tags)i.set(r,(i.get(r)||0)+1);let n=[];for(let[o,r]of i)r>=2&&n.push(o);return n.slice(0,5)}async callLLM(t){switch(this.config.provider){case"claude":return this.callClaude(t);case"openai":return this.callOpenAI(t);case"gemini":return this.callGemini(t);case"grok":return this.callGrok(t);default:throw new Error(`Unsupported provider: ${this.config.provider}`)}}async callClaude(t){let e=await(0,h.requestUrl)({url:"https://api.anthropic.com/v1/messages",method:"POST",headers:{"x-api-key":this.config.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify({model:this.model,max_tokens:4e3,messages:[{role:"user",content:t}]})});if(e.status!==200)throw new Error(`Claude API error: ${e.status}`);return e.json.content[0].text}async callOpenAI(t){let e=this.model.startsWith("gpt-5")||this.model.startsWith("o1")||this.model.startsWith("o3"),s={model:this.model,messages:[{role:"user",content:t}],temperature:.7};e?s.max_completion_tokens=4e3:s.max_tokens=4e3;let i=await(0,h.requestUrl)({url:"https://api.openai.com/v1/chat/completions",method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(i.status!==200)throw new Error(`OpenAI API error: ${i.status}`);return i.json.choices[0].message.content}async callGemini(t){let e=`https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${this.config.apiKey}`,s=await(0,h.requestUrl)({url:e,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:t}]}],generationConfig:{temperature:.7,maxOutputTokens:4e3}})});if(s.status!==200)throw new Error(`Gemini API error: ${s.status}`);return s.json.candidates[0].content.parts[0].text}async callGrok(t){let e=await(0,h.requestUrl)({url:"https://api.x.ai/v1/chat/completions",method:"POST",headers:{Authorization:`Bearer ${this.config.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:[{role:"user",content:t}],temperature:.7,max_tokens:4e3})});if(e.status!==200)throw new Error(`Grok API error: ${e.status}`);return e.json.choices[0].message.content}};var A=class{constructor(t){this.app=t}async getNote(t){let s=this.app.vault.getMarkdownFiles().find(i=>i.basename===t);return s?this.fileToNoteContent(s):null}async getNoteByPath(t){let e=this.app.vault.getFileByPath(t);return e?this.fileToNoteContent(e):null}async getNotesByTag(t){let e=[],s=this.app.vault.getMarkdownFiles();for(let i of s){let n=this.app.metadataCache.getFileCache(i);if(this.hasTag(n,t)){let o=await this.fileToNoteContent(i);o&&e.push(o)}}return e}async getNotesByFolder(t){var i;let e=[],s=this.app.vault.getMarkdownFiles();for(let n of s){let o=((i=n.parent)==null?void 0:i.path)||"";if(o===t||o.startsWith(t+"/")){let r=await this.fileToNoteContent(n);r&&e.push(r)}}return e}async getAllNotes(){let t=[],e=this.app.vault.getMarkdownFiles();for(let s of e){let i=await this.fileToNoteContent(s);i&&t.push(i)}return t}async createNote(t,e){let s=t.substring(0,t.lastIndexOf("/"));s&&(this.app.vault.getAbstractFileByPath(s)||await this.app.vault.createFolder(s)),await this.app.vault.create(t,e)}async updateNote(t,e){let s=this.app.vault.getFileByPath(t);s&&await this.app.vault.modify(s,e)}async getAllTags(){var s;let t=new Set,e=this.app.vault.getMarkdownFiles();for(let i of e){let n=this.app.metadataCache.getFileCache(i);if(n!=null&&n.tags)for(let o of n.tags)t.add(o.tag.replace(/^#/,""));if((s=n==null?void 0:n.frontmatter)!=null&&s.tags){let o=n.frontmatter.tags;if(Array.isArray(o))for(let r of o)t.add(String(r).replace(/^#/,""))}}return Array.from(t).sort()}async getAllFolders(){var s;let t=new Set,e=this.app.vault.getMarkdownFiles();for(let i of e){let n=(s=i.parent)==null?void 0:s.path;n&&n!=="/"&&t.add(n)}return Array.from(t).sort()}async fileToNoteContent(t){var e,s;try{let i=await this.app.vault.cachedRead(t),n=this.app.metadataCache.getFileCache(t),o=[];if(n!=null&&n.tags)for(let a of n.tags)o.push(a.tag.replace(/^#/,""));if((e=n==null?void 0:n.frontmatter)!=null&&e.tags){let a=n.frontmatter.tags;if(Array.isArray(a))for(let c of a)o.push(String(c).replace(/^#/,""))}let r=this.extractBody(i);return{noteId:t.basename,notePath:t.path,title:((s=n==null?void 0:n.frontmatter)==null?void 0:s.title)||t.basename,content:r,tags:[...new Set(o)]}}catch(i){return console.error(`Error reading file ${t.path}:`,i),null}}extractBody(t){let e=/^---\n[\s\S]*?\n---\n*/;return t.replace(e,"").trim()}hasTag(t,e){var s;if(!t)return!1;if(t.tags)for(let i of t.tags){let n=i.tag.replace(/^#/,"");if(n===e||n.startsWith(e+"/"))return!0}if((s=t.frontmatter)!=null&&s.tags){let i=t.frontmatter.tags;if(Array.isArray(i))for(let n of i){let o=String(n).replace(/^#/,"");if(o===e||o.startsWith(e+"/"))return!0}}return!1}};var $={ai:{provider:"openai",apiKeys:{},models:{claude:u.claude.defaultModel,openai:u.openai.defaultModel,gemini:u.gemini.defaultModel,grok:u.grok.defaultModel}},outputFolder:"Synthesized",defaultSynthesisOptions:{includeBacklinks:!0,autoSuggestTags:!0,language:"ko"},clusterOptions:{minClusterSize:3,minCoherence:.4,maxSuggestions:5}};var p=require("obsidian");var k=class extends p.PluginSettingTab{constructor(e,s){super(e,s);this.modelDropdown=null;this.plugin=s}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Knowledge Synthesizer \uC124\uC815"}),this.displayAISettings(e),e.createEl("h3",{text:"\uCD9C\uB825 \uC124\uC815"}),new p.Setting(e).setName("\uCD9C\uB825 \uD3F4\uB354").setDesc("\uD569\uC131\uB41C \uB178\uD2B8\uB97C \uC800\uC7A5\uD560 \uD3F4\uB354").addText(i=>i.setPlaceholder("Synthesized").setValue(this.plugin.settings.outputFolder).onChange(async n=>{this.plugin.settings.outputFolder=n||"Synthesized",await this.plugin.saveSettings()})),e.createEl("h3",{text:"\uD569\uC131 \uC635\uC158"}),new p.Setting(e).setName("\uC5ED\uB9C1\uD06C \uD3EC\uD568").setDesc("\uD569\uC131\uB41C \uB178\uD2B8\uC5D0 \uC6D0\uBCF8 \uB178\uD2B8\uB85C\uC758 \uB9C1\uD06C\uB97C \uD3EC\uD568\uD569\uB2C8\uB2E4").addToggle(i=>i.setValue(this.plugin.settings.defaultSynthesisOptions.includeBacklinks).onChange(async n=>{this.plugin.settings.defaultSynthesisOptions.includeBacklinks=n,await this.plugin.saveSettings()})),new p.Setting(e).setName("\uC790\uB3D9 \uD0DC\uADF8 \uC81C\uC548").setDesc("\uC6D0\uBCF8 \uB178\uD2B8\uB4E4\uC758 \uD0DC\uADF8\uB97C \uBD84\uC11D\uD558\uC5EC \uD569\uC131 \uB178\uD2B8\uC5D0 \uD0DC\uADF8\uB97C \uC81C\uC548\uD569\uB2C8\uB2E4").addToggle(i=>i.setValue(this.plugin.settings.defaultSynthesisOptions.autoSuggestTags).onChange(async n=>{this.plugin.settings.defaultSynthesisOptions.autoSuggestTags=n,await this.plugin.saveSettings()})),new p.Setting(e).setName("\uAE30\uBCF8 \uC5B8\uC5B4").setDesc("\uD569\uC131 \uACB0\uACFC\uC758 \uAE30\uBCF8 \uC5B8\uC5B4").addDropdown(i=>i.addOption("ko","\uD55C\uAD6D\uC5B4").addOption("en","English").setValue(this.plugin.settings.defaultSynthesisOptions.language).onChange(async n=>{this.plugin.settings.defaultSynthesisOptions.language=n,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\uD074\uB7EC\uC2A4\uD130\uB9C1 \uC635\uC158"}),new p.Setting(e).setName("\uCD5C\uC18C \uD074\uB7EC\uC2A4\uD130 \uD06C\uAE30").setDesc("\uD569\uC131\uC744 \uCD94\uCC9C\uD560 \uCD5C\uC18C \uB178\uD2B8 \uC218").addSlider(i=>i.setLimits(2,10,1).setValue(this.plugin.settings.clusterOptions.minClusterSize).setDynamicTooltip().onChange(async n=>{this.plugin.settings.clusterOptions.minClusterSize=n,await this.plugin.saveSettings()})),new p.Setting(e).setName("\uCD5C\uC18C \uC751\uC9D1\uB3C4").setDesc("\uD074\uB7EC\uC2A4\uD130\uC758 \uCD5C\uC18C \uC751\uC9D1\uB3C4 (0.0 ~ 1.0)").addSlider(i=>i.setLimits(.1,.9,.1).setValue(this.plugin.settings.clusterOptions.minCoherence).setDynamicTooltip().onChange(async n=>{this.plugin.settings.clusterOptions.minCoherence=n,await this.plugin.saveSettings()})),new p.Setting(e).setName("\uCD5C\uB300 \uCD94\uCC9C \uC218").setDesc("\uD55C \uBC88\uC5D0 \uD45C\uC2DC\uD560 \uCD5C\uB300 \uD569\uC131 \uCD94\uCC9C \uC218").addSlider(i=>i.setLimits(3,20,1).setValue(this.plugin.settings.clusterOptions.maxSuggestions).setDynamicTooltip().onChange(async n=>{this.plugin.settings.clusterOptions.maxSuggestions=n,await this.plugin.saveSettings()})),e.createEl("h3",{text:"\uC815\uBCF4"});let s=e.createDiv({cls:"setting-item"});s.createEl("p",{text:"Knowledge Synthesizer v0.2.0",cls:"setting-item-description"}),s.createEl("p",{text:"\uAD00\uB828 \uB178\uD2B8\uB4E4\uC744 AI\uB85C \uD569\uC131\uD558\uC5EC \uC0C1\uC704 \uC778\uC0AC\uC774\uD2B8 \uB178\uD2B8\uB97C \uC0DD\uC131\uD569\uB2C8\uB2E4.",cls:"setting-item-description"})}displayAISettings(e){e.createEl("h3",{text:"AI \uC124\uC815"});let s=this.plugin.settings.ai.provider,i=u[s];new p.Setting(e).setName("AI \uD504\uB85C\uBC14\uC774\uB354").setDesc("\uC0AC\uC6A9\uD560 AI \uC11C\uBE44\uC2A4\uB97C \uC120\uD0DD\uD558\uC138\uC694").addDropdown(o=>{Object.entries(u).forEach(([r,a])=>{o.addOption(r,a.displayName)}),o.setValue(s),o.onChange(async r=>{this.plugin.settings.ai.provider=r,await this.plugin.saveSettings(),this.display()})}),new p.Setting(e).setName(`${i.displayName} API \uD0A4`).setDesc(this.getApiKeyDescription(s)).addText(o=>{var r;o.setPlaceholder("API \uD0A4 \uC785\uB825").setValue((r=this.plugin.settings.ai.apiKeys[s])!=null?r:"").onChange(async a=>{this.plugin.settings.ai.apiKeys[s]=a,await this.plugin.saveSettings()}),o.inputEl.type="password",o.inputEl.style.width="300px"}).addButton(o=>{o.setButtonText("\uD14C\uC2A4\uD2B8").onClick(async()=>{let r=this.plugin.settings.ai.apiKeys[s];if(!r){new p.Notice("API \uD0A4\uB97C \uBA3C\uC800 \uC785\uB825\uD574\uC8FC\uC138\uC694.");return}o.setDisabled(!0),o.setButtonText("\uD14C\uC2A4\uD2B8 \uC911...");try{await this.plugin.testApiKey(s,r)?new p.Notice(`\u2705 ${i.displayName} API \uD0A4\uAC00 \uC720\uD6A8\uD569\uB2C8\uB2E4!`):new p.Notice(`\u274C ${i.displayName} API \uD0A4\uAC00 \uC720\uD6A8\uD558\uC9C0 \uC54A\uC2B5\uB2C8\uB2E4.`)}catch(a){let c=a instanceof Error?a.message:"\uC54C \uC218 \uC5C6\uB294 \uC624\uB958";new p.Notice(`\u274C \uD14C\uC2A4\uD2B8 \uC2E4\uD328: ${c}`)}finally{o.setDisabled(!1),o.setButtonText("\uD14C\uC2A4\uD2B8")}})}),new p.Setting(e).setName("\uBAA8\uB378").setDesc("\uC0AC\uC6A9\uD560 \uBAA8\uB378\uC744 \uC120\uD0DD\uD558\uC138\uC694").addDropdown(o=>{var r;this.modelDropdown=o,this.populateModelDropdown(o,s),o.setValue((r=this.plugin.settings.ai.models[s])!=null?r:i.defaultModel),o.onChange(async a=>{this.plugin.settings.ai.models[s]=a,await this.plugin.saveSettings()})}),s!=="openai"&&new p.Setting(e).setName("OpenAI API \uD0A4 (\uC784\uBCA0\uB529 \uC804\uC6A9)").setDesc("\uC758\uBBF8 \uAE30\uBC18 \uAC80\uC0C9\uC5D0 \uC0AC\uC6A9\uD560 OpenAI API \uD0A4").addText(o=>{var r;o.setPlaceholder("sk-...").setValue((r=this.plugin.settings.ai.apiKeys.openai)!=null?r:"").onChange(async a=>{this.plugin.settings.ai.apiKeys.openai=a,await this.plugin.saveSettings()}),o.inputEl.type="password",o.inputEl.style.width="300px"});let n=e.createDiv({cls:"setting-item-description"});n.style.marginTop="10px",n.style.fontStyle="italic",n.innerHTML="\u203B \uC758\uBBF8 \uAE30\uBC18 \uD074\uB7EC\uC2A4\uD130\uB9C1\uC740 OpenAI API (text-embedding-3-small)\uB97C \uC0AC\uC6A9\uD569\uB2C8\uB2E4. \uD0DC\uADF8/\uD3F4\uB354 \uAE30\uBC18 \uD074\uB7EC\uC2A4\uD130\uB9C1\uC740 API \uD0A4 \uC5C6\uC774\uB3C4 \uC791\uB3D9\uD569\uB2C8\uB2E4."}populateModelDropdown(e,s){R(s).forEach(n=>{e.addOption(n.id,n.displayName)})}getApiKeyDescription(e){switch(e){case"claude":return"https://console.anthropic.com \uC5D0\uC11C \uBC1C\uAE09\uBC1B\uC744 \uC218 \uC788\uC2B5\uB2C8\uB2E4.";case"openai":return"https://platform.openai.com \uC5D0\uC11C \uBC1C\uAE09\uBC1B\uC744 \uC218 \uC788\uC2B5\uB2C8\uB2E4.";case"gemini":return"https://aistudio.google.com \uC5D0\uC11C \uBC1C\uAE09\uBC1B\uC744 \uC218 \uC788\uC2B5\uB2C8\uB2E4.";case"grok":return"https://console.x.ai \uC5D0\uC11C \uBC1C\uAE09\uBC1B\uC744 \uC218 \uC788\uC2B5\uB2C8\uB2E4.";default:return"API \uD0A4\uB97C \uC785\uB825\uD558\uC138\uC694."}}};var d=require("obsidian"),w="knowledge-synthesizer-view",v=class extends d.ItemView{constructor(e,s){super(e);this.suggestions=[];this.isLoading=!1;this.plugin=s}getViewType(){return w}getDisplayText(){return"Knowledge Synthesizer"}getIcon(){return"layers"}async onOpen(){await this.render()}async onClose(){}async render(){let e=this.containerEl.children[1];if(e.empty(),e.addClass("synthesis-view-container"),e.createDiv({cls:"synthesis-view-header"}).createEl("h4",{text:"Knowledge Synthesizer"}),!this.plugin.isConfigured()){let r=e.createDiv({cls:"synthesis-warning"});r.createEl("p",{text:"\u26A0\uFE0F API \uD0A4\uAC00 \uC124\uC815\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4."}),r.createEl("p",{text:"\uC124\uC815\uC5D0\uC11C OpenAI API \uD0A4\uB97C \uC785\uB825\uD558\uC138\uC694."});return}if(e.createDiv({cls:"synthesis-actions"}).createEl("button",{text:"\uCD94\uCC9C \uC0C8\uB85C\uACE0\uCE68"}).addEventListener("click",()=>this.loadSuggestions()),this.isLoading){e.createDiv({cls:"synthesis-loading"}).createEl("p",{text:"\uBD84\uC11D \uC911..."});return}if(this.suggestions.length===0){let r=e.createDiv({cls:"synthesis-empty"});r.createEl("p",{text:"\uD569\uC131 \uAC00\uB2A5\uD55C \uD074\uB7EC\uC2A4\uD130\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4."}),r.createEl("p",{text:"\uB178\uD2B8\uB97C \uCD94\uAC00\uD558\uAC70\uB098 \uD0DC\uADF8\uB97C \uC0AC\uC6A9\uD574\uBCF4\uC138\uC694."});return}let o=e.createDiv({cls:"synthesis-suggestions"});for(let r of this.suggestions)this.renderSuggestion(o,r)}renderSuggestion(e,s){let i=e.createDiv({cls:"synthesis-suggestion-card"}),n=i.createDiv({cls:"suggestion-header"}),o=n.createSpan({cls:`priority-icon priority-${s.priority}`});(0,d.setIcon)(o,this.getPriorityIcon(s.priority)),n.createEl("span",{text:s.cluster.name,cls:"suggestion-title"});let r=i.createDiv({cls:"suggestion-info"});r.createEl("span",{text:`${s.cluster.members.length}\uAC1C \uB178\uD2B8`}),r.createEl("span",{text:`\uC751\uC9D1\uB3C4: ${(s.cluster.coherenceScore*100).toFixed(0)}%`}),i.createEl("p",{text:s.reason,cls:"suggestion-reason"});let a=i.createDiv({cls:"suggestion-notes"}),c=a.createEl("button",{text:"\uB178\uD2B8 \uBAA9\uB85D \uBCF4\uAE30",cls:"toggle-notes"}),g=a.createDiv({cls:"note-list-content hidden"});for(let y of s.cluster.members.slice(0,10))g.createEl("div",{text:`\u2022 ${y.title}`,cls:"note-item"});s.cluster.members.length>10&&g.createEl("div",{text:`... \uADF8 \uC678 ${s.cluster.members.length-10}\uAC1C`,cls:"note-item more"}),c.addEventListener("click",()=>{g.classList.toggle("hidden"),c.textContent=g.classList.contains("hidden")?"\uB178\uD2B8 \uBAA9\uB85D \uBCF4\uAE30":"\uB178\uD2B8 \uBAA9\uB85D \uC228\uAE30\uAE30"});let f=i.createDiv({cls:"suggestion-actions"}),P=f.createEl("select",{cls:"synthesis-type-select"}),L=[{value:"framework",label:"\uC885\uD569 \uD504\uB808\uC784\uC6CC\uD06C"},{value:"summary",label:"\uC694\uC57D"},{value:"comparison",label:"\uBE44\uAD50 \uBD84\uC11D"},{value:"timeline",label:"\uD0C0\uC784\uB77C\uC778"}];for(let y of L){let F=P.createEl("option",{value:y.value,text:y.label});y.value===s.suggestedType&&(F.selected=!0)}f.createEl("button",{text:"\uD569\uC131\uD558\uAE30",cls:"mod-cta"}).addEventListener("click",async()=>{let y=P.value;await this.synthesize(s,y)})}getPriorityIcon(e){switch(e){case"high":return"star";case"medium":return"circle";default:return"circle-dot"}}async loadSuggestions(){if(!this.plugin.suggestSynthesisUseCase){new d.Notice("\uC11C\uBE44\uC2A4\uAC00 \uCD08\uAE30\uD654\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.");return}this.isLoading=!0,await this.render();try{let e=this.app.workspace.getActiveFile(),s=[];e&&s.push(e.basename);let i=this.app.vault.getMarkdownFiles().slice(0,5);for(let n of i)s.includes(n.basename)||s.push(n.basename);this.suggestions=await this.plugin.suggestSynthesisUseCase.suggestAll(s,{minClusterSize:this.plugin.settings.clusterOptions.minClusterSize,minCoherence:this.plugin.settings.clusterOptions.minCoherence,maxSuggestions:this.plugin.settings.clusterOptions.maxSuggestions})}catch(e){console.error("Failed to load suggestions:",e),new d.Notice("\uCD94\uCC9C \uB85C\uB4DC \uC2E4\uD328: "+(e instanceof Error?e.message:String(e)))}finally{this.isLoading=!1,await this.render()}}async synthesize(e,s){if(!this.plugin.synthesizeNotesUseCase){new d.Notice("\uC11C\uBE44\uC2A4\uAC00 \uCD08\uAE30\uD654\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4.");return}new d.Notice("\uD569\uC131 \uC911...");try{let{result:i}=await this.plugin.synthesizeNotesUseCase.execute({cluster:e.cluster,synthesisType:s,options:this.plugin.settings.defaultSynthesisOptions}),n=await this.plugin.synthesizeNotesUseCase.saveResult(i,this.plugin.settings.outputFolder);new d.Notice(`\uD569\uC131 \uC644\uB8CC: ${i.title}`);let o=this.app.vault.getFileByPath(n);o&&await this.app.workspace.getLeaf().openFile(o)}catch(i){console.error("Synthesis failed:",i),new d.Notice("\uD569\uC131 \uC2E4\uD328: "+(i instanceof Error?i.message:String(i)))}}};var O=class extends D.Plugin{constructor(){super(...arguments);this.embeddingProvider=null;this.vectorStore=null;this.synthesisGenerator=null;this.noteRepository=null;this.embeddingService=null;this.clusterNotesUseCase=null;this.synthesizeNotesUseCase=null;this.suggestSynthesisUseCase=null}async onload(){console.log("Loading Knowledge Synthesizer Plugin"),await this.loadSettings(),this.initializeServices(),this.registerView(w,e=>new v(e,this)),this.addCommand({id:"open-synthesis-view",name:"Open Synthesis View",callback:()=>this.activateView()}),this.addCommand({id:"synthesize-current-tag",name:"Synthesize notes with current note's primary tag",callback:()=>this.synthesizeCurrentTag()}),this.addSettingTab(new k(this.app,this)),this.addRibbonIcon("layers","Knowledge Synthesizer",()=>this.activateView())}async onunload(){var e;console.log("Unloading Knowledge Synthesizer Plugin"),(e=this.vectorStore)==null||e.clear()}async loadSettings(){this.settings=Object.assign({},$,await this.loadData()),this.migrateSettings()}async saveSettings(){await this.saveData(this.settings),this.initializeServices()}migrateSettings(){let e=this.settings;if(e.openaiApiKey&&!this.settings.ai.apiKeys.openai&&(this.settings.ai.apiKeys.openai=e.openaiApiKey,delete e.openaiApiKey),e.anthropicApiKey&&!this.settings.ai.apiKeys.claude&&(this.settings.ai.apiKeys.claude=e.anthropicApiKey,delete e.anthropicApiKey),e.llmProvider&&(e.llmProvider==="anthropic"?this.settings.ai.provider="claude":e.llmProvider==="openai"&&(this.settings.ai.provider="openai"),delete e.llmProvider),e.model){let s=this.settings.ai.provider;this.settings.ai.models[s]=e.model,delete e.model}}isConfigured(){let e=this.settings.ai.provider;return!!this.settings.ai.apiKeys[e]}async testApiKey(e,s){var o;let i=(o=this.settings.ai.models[e])!=null?o:u[e].defaultModel;return new S({provider:e,apiKey:s,model:i}).testApiKey(s)}initializeServices(){let e=this.settings.ai.provider,s=this.settings.ai.apiKeys[e];if(!s){console.log("Knowledge Synthesizer: LLM API key not configured");return}try{this.noteRepository=new A(this.app);let i=this.settings.ai.apiKeys.openai;i?(this.embeddingProvider=new I(i),this.vectorStore=new x,this.embeddingService=new C(this.embeddingProvider,this.vectorStore)):(console.log("Knowledge Synthesizer: OpenAI API key not configured for embeddings"),this.embeddingProvider=null,this.vectorStore=null,this.embeddingService=null);let n={provider:e,apiKey:s,model:this.settings.ai.models[e]};this.synthesisGenerator=new S(n),this.embeddingService&&(this.clusterNotesUseCase=new b(this.embeddingService,this.noteRepository)),this.synthesizeNotesUseCase=new N(this.synthesisGenerator,this.noteRepository),this.clusterNotesUseCase&&(this.suggestSynthesisUseCase=new T(this.clusterNotesUseCase,this.noteRepository)),console.log("Knowledge Synthesizer: Services initialized")}catch(i){console.error("Failed to initialize services:",i)}}async activateView(){let{workspace:e}=this.app,s=e.getLeavesOfType(w)[0];if(!s){let i=e.getRightLeaf(!1);i&&(s=i,await s.setViewState({type:w,active:!0}))}if(s){e.revealLeaf(s);let i=s.view;i instanceof v&&await i.loadSuggestions()}}async synthesizeCurrentTag(){let e=this.app.workspace.getActiveFile();if(!e)return;let s=this.app.metadataCache.getFileCache(e);if(!(s!=null&&s.tags)||s.tags.length===0)return;let i=s.tags[0].tag.replace(/^#/,"");if(!(!this.clusterNotesUseCase||!this.synthesizeNotesUseCase))try{let n=await this.clusterNotesUseCase.clusterByTag(i);if(n.members.length<2)return;let{result:o}=await this.synthesizeNotesUseCase.execute({cluster:n,synthesisType:"framework",options:this.settings.defaultSynthesisOptions});await this.synthesizeNotesUseCase.saveResult(o,this.settings.outputFolder)}catch(n){console.error("Failed to synthesize:",n)}}};
